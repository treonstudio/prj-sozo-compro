name: Push Notification

on:
  push:
    branches: [ main ]

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: Get changed files
      id: changes
      run: |
        echo "changed_files=$(git diff --name-only HEAD^ HEAD)" >> $GITHUB_OUTPUT
        echo "app_changed=$(git diff --name-only HEAD^ HEAD | grep -q '^apps/app/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "web_changed=$(git diff --name-only HEAD^ HEAD | grep -q '^apps/web/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "website_changed=$(git diff --name-only HEAD^ HEAD | grep -q '^apps/website/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "extension_changed=$(git diff --name-only HEAD^ HEAD | grep -q '^apps/browser-extension/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        
    - name: Get commit info
      id: commit
      run: |
        echo "commit_message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
        echo "commit_author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
        echo "commit_short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        
    - name: Send Discord notification
      run: |
        # Determine which apps changed
        CHANGED_APPS=""
        APP_COUNT=0

        if [[ "${{ steps.changes.outputs.app_changed }}" == "true" ]]; then
          CHANGED_APPS="$CHANGED_APPS\nğŸ“±  **Mobile App**\n     *(Muslimfy App)*\n"
          APP_COUNT=$((APP_COUNT + 1))
        fi

        if [[ "${{ steps.changes.outputs.web_changed }}" == "true" ]]; then
          CHANGED_APPS="$CHANGED_APPS\nğŸŒ  **Web App**\n     *(Muslimfy Web Application)*\n"
          APP_COUNT=$((APP_COUNT + 1))
        fi

        if [[ "${{ steps.changes.outputs.website_changed }}" == "true" ]]; then
          CHANGED_APPS="$CHANGED_APPS\nğŸ–¥ï¸  **Website**\n     *(Muslimfy Website)*\n"
          APP_COUNT=$((APP_COUNT + 1))
        fi

        if [[ "${{ steps.changes.outputs.extension_changed }}" == "true" ]]; then
          CHANGED_APPS="$CHANGED_APPS\nğŸ§©  **Browser Extension**\n     *(Muslimfy Browser Extension)*\n"
          APP_COUNT=$((APP_COUNT + 1))
        fi
        
        # If no mapped folders changed, show generic message
        if [[ -z "$CHANGED_APPS" ]]; then
          CHANGED_APPS="\nğŸ“‹  **Project Configuration**\n     *(Build scripts, configs, etc)*"
          APP_COUNT=1
        fi
        
        # Set title and description based on which apps changed
        if [[ "${{ steps.changes.outputs.app_changed }}" == "true" && $APP_COUNT == 1 ]]; then
          TITLE="ğŸ“± ${{ steps.commit.outputs.commit_author }} just pushed"
          DESCRIPTION="Directly push to **Muslimfy Mobile App** on develop branch"
        elif [[ "${{ steps.changes.outputs.web_changed }}" == "true" && $APP_COUNT == 1 ]]; then
          TITLE="ğŸŒ ${{ steps.commit.outputs.commit_author }} just pushed"
          DESCRIPTION="Updates deployed to **Muslimfy Web App** on develop branch"
        elif [[ "${{ steps.changes.outputs.website_changed }}" == "true" && $APP_COUNT == 1 ]]; then
          TITLE="ğŸ–¥ï¸ ${{ steps.commit.outputs.commit_author }} just pushed"
          DESCRIPTION="Updates deployed to **Muslimfy Website** on develop branch"
        elif [[ "${{ steps.changes.outputs.extension_changed }}" == "true" && $APP_COUNT == 1 ]]; then
          TITLE="ğŸ§© ${{ steps.commit.outputs.commit_author }} just pushed"
          DESCRIPTION="Updates deployed to **Muslimfy Browser Extension** on develop branch"
        elif [[ $APP_COUNT == 1 ]]; then
          TITLE="ğŸ“‹ ${{ steps.commit.outputs.commit_author }} just pushed"
          DESCRIPTION="Directly push to **Project Configuration** on develop branch"
        else
          TITLE="ğŸš€ ${{ steps.commit.outputs.commit_author }} just pushed"
          DESCRIPTION="Directly push to **$APP_COUNT applications** on develop branch"
        fi
        
        curl -H "Content-Type: application/json" \
        -X POST \
        -d "{
          \"embeds\": [
            {
              \"author\": {
                \"name\": \"Sozo Development Update\",
                \"icon_url\": \"https://cdn.jsdelivr.net/gh/primer/octicons/icons/code-24.svg\"
              },
              \"title\": \"$TITLE\",
              \"description\": \"$DESCRIPTION\",
              \"color\": 3447003,
              \"fields\": [
                {
                  \"name\": \"ğŸ“ What Changed\",
                  \"value\": \"\n> *${{ steps.commit.outputs.commit_message }}*\n\",
                  \"inline\": false
                },
                {
                  \"name\": \"ğŸ”— Quick Actions\",
                  \"value\": \"\nğŸ” [View Commit Details](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\n\nğŸŒ¿ [Browse Source Code](https://github.com/${{ github.repository }}/tree/develop)\n\nğŸ“Š [Compare All Changes](https://github.com/${{ github.repository }}/compare/${{ github.sha }}^..${{ github.sha }})\n\",
                  \"inline\": false
                }
              ],
              \"footer\": {
                \"text\": \"Commit ${{ steps.commit.outputs.commit_short_sha }} â€¢ $(date +'%B %d, %Y at %I:%M %p')\",
                \"icon_url\": \"https://cdn.jsdelivr.net/gh/primer/octicons/icons/git-branch-24.svg\"
              },
              \"timestamp\": \"${{ github.event.head_commit.timestamp }}\"
            }
          ]
        }" \
        https://discord.com/api/webhooks/1421271675797770359/gO1aLOEbfYtIb7HaZZcyS3-9fjozu3kKiTJL6afyhFqOq_vW0GH_PSF4ipZdnQ7mvvya